import{j as e,e as Y,g as F,h as K,i as B,k as P}from"./ui-vendor-Dh6LInB3.js";import{r as v,d as q,u as G}from"./react-vendor-DWv6uwxK.js";import{C as W,a as O,b as J,B as C,e as I,c as H,u as Q,s as $}from"./auth-CHX4A9zW.js";import{B as R}from"./badge-DNnRTJZ8.js";import{a as k}from"./utils-vendor-BZaDkFqu.js";import{w as V}from"./whatsappService-XKbNxRgI.js";import"./supabase-vendor-Dgy_jg73.js";const S=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],z=Array.from({length:24},(c,x)=>x);function X({onSave:c,initialAvailability:x}){const[b,p]=v.useState(()=>{const t={};return S.forEach(a=>{t[a.toLowerCase()]=new Set}),t}),[A,D]=v.useState(!1),[L,T]=v.useState("add"),[M,j]=v.useState(!1),[f,E]=v.useState(0);v.useEffect(()=>{if(console.log("AvailabilityCalendar: Week offset changed to:",f),console.log("AvailabilityCalendar: Initial availability:",x),f===0&&x){const t={};S.forEach(a=>{const s=a.toLowerCase(),o=x[s];t[s]=o?new Set(o):new Set}),console.log("AvailabilityCalendar: Setting current week availability:",t),p(t),j(!1)}else{const t={};S.forEach(a=>{t[a.toLowerCase()]=new Set}),console.log("AvailabilityCalendar: Clearing availability for non-current week"),p(t),j(!1)}},[f,x]);const _=(t,a,s)=>{s&&"touches"in s&&s.preventDefault(),D(!0),j(!0);const o=t.toLowerCase(),u=b[o].has(a);T(u?"remove":"add"),p(l=>{const w={...l},N=new Set(w[o]);return u?N.delete(a):N.add(a),w[o]=N,w})},g=(t,a)=>{if(!A)return;const s=t.toLowerCase();p(o=>{const u={...o},l=new Set(u[s]);return L==="add"?l.add(a):l.delete(a),u[s]=l,u})},i=()=>{D(!1)},m=t=>{const a=t>=12?"PM":"AM";return`${t===0?12:t>12?t-12:t}${a}`},d=()=>{c(b),j(!1)},h=()=>{const t={};S.forEach(a=>{t[a.toLowerCase()]=new Set}),p(t),j(!0)},r=()=>{const t=Object.values(b).reduce((a,s)=>s instanceof Set?a+s.size:(console.warn("AvailabilityCalendar: Invalid daySlots detected:",s),a),0);return console.log("AvailabilityCalendar: Total slots calculated:",t),t},n=()=>{const t=new Date,a=new Date(t),s=t.getDay(),o=s===0?-6:1-s;return a.setDate(t.getDate()+o+f*7),S.map((u,l)=>{const w=new Date(a);return w.setDate(a.getDate()+l),w})},y=()=>{const t=n(),a=t[0],s=t[6],o=u=>u.toLocaleDateString("en-US",{month:"short",day:"numeric"});return a.getMonth()===s.getMonth()?`${o(a)} - ${o(s)}`:`${o(a)} - ${o(s)}`};return e.jsxs("div",{className:"w-full space-y-6",children:[e.jsx(W,{children:e.jsxs(O,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Y,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx(J,{className:"text-lg",children:"Set Your Availability"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Week of ",y()]})]})]}),e.jsxs(R,{variant:"secondary",children:[r()," slots selected"]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4",children:[e.jsxs(C,{variant:"outline",size:"sm",onClick:()=>E(f-1),disabled:f<=0,children:[e.jsx(F,{className:"h-4 w-4 mr-1"}),"Previous Week"]}),e.jsx(C,{variant:"ghost",size:"sm",onClick:()=>E(0),disabled:f===0,children:"This Week"}),e.jsxs(C,{variant:"outline",size:"sm",onClick:()=>E(f+1),children:["Next Week",e.jsx(K,{className:"h-4 w-4 ml-1"})]})]})]})}),e.jsx("div",{className:"block lg:hidden space-y-4",children:S.map((t,a)=>{const o=n()[a],u=t.toLowerCase();return e.jsxs(W,{children:[e.jsx(O,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:t}),e.jsx("p",{className:"text-sm text-muted-foreground",children:o.toLocaleDateString("en-US",{month:"short",day:"numeric"})})]}),e.jsxs(R,{variant:"outline",children:[b[u].size," hours"]})]})}),e.jsx(I,{children:e.jsx("div",{className:"grid grid-cols-4 sm:grid-cols-6 gap-2",children:z.filter(l=>l>=6&&l<=23).map(l=>{const w=b[u].has(l);return e.jsx("button",{className:H("p-2 text-xs rounded border transition-all select-none",w?"bg-primary border-primary text-primary-foreground font-medium":"bg-background border-border hover:bg-muted active:bg-muted"),style:{touchAction:"manipulation",WebkitTapHighlightColor:"transparent"},onClick:N=>{N.preventDefault(),_(t,l,N)},children:m(l)},`${t}-${l}`)})})})]},t)})}),e.jsx(W,{className:"hidden lg:block",onMouseUp:i,onMouseLeave:i,children:e.jsx(I,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Click and drag to select your available time slots. Each slot represents 1 hour."}),e.jsx("div",{className:"overflow-x-auto",children:e.jsx("div",{className:"min-w-[800px]",children:e.jsxs("div",{className:"grid grid-cols-[80px_repeat(24,1fr)] gap-1",children:[e.jsx("div",{className:"h-8"}),z.map(t=>e.jsx("div",{className:"text-xs text-center text-muted-foreground",children:m(t)},t)),S.map(t=>e.jsxs(q.Fragment,{children:[e.jsx("div",{className:"font-medium text-sm py-2",children:e.jsx("div",{children:t})}),z.map(a=>{const s=t.toLowerCase(),o=b[s].has(a);return e.jsx("div",{className:H("h-10 border rounded cursor-pointer transition-all select-none",o?"bg-primary border-primary text-primary-foreground":"bg-background border-border hover:bg-muted"),style:{touchAction:"manipulation",WebkitTapHighlightColor:"transparent"},onMouseDown:u=>_(t,a,u),onMouseEnter:()=>g(t,a)},`${t}-${a}`)})]},t))]})})})]})})}),e.jsx(W,{children:e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 sm:justify-end",children:[e.jsx(C,{variant:"outline",onClick:h,className:"w-full sm:w-auto",children:"Clear All"}),e.jsx(C,{onClick:d,disabled:!M,className:"w-full sm:w-auto",children:"Save Availability"})]})})})]})}function oe(){const{user:c,profile:x}=Q(),b=G(),[p,A]=v.useState(!0),[D,L]=v.useState(!1),[T,M]=v.useState();v.useEffect(()=>{if(c){f();const g=$.channel("availability-changes-all").on("postgres_changes",{event:"*",schema:"public",table:"availability"},i=>{console.log("Availability page: Change detected:",i);const m=i.new?.user_id||i.old?.user_id;m===c.id?(console.log("Availability page: Change affects current user, reloading"),f(),k.info("Your availability has been updated",{description:"The changes are now reflected on the calendar"})):console.log("Availability page: Change affects different user:",m)}).subscribe();return()=>{g.unsubscribe()}}},[c]);const j=async()=>{L(!0),await f(),k.success("Availability refreshed"),L(!1)},f=async()=>{if(c)try{console.log("Loading availability for user:",c.id);const g=new Date().getTime();console.log("Loading availability with timestamp:",g);const{data:i,error:m}=await $.from("availability").select("*").eq("user_id",c.id).order("created_at",{ascending:!1});console.log("Load availability result:",{data:i,error:m,count:i?.length||0}),m&&console.error("Error loading availability:",m);const d={};if(U.forEach(h=>{d[h.toLowerCase()]=new Set}),i&&Array.isArray(i)&&i.length>0){console.log("Processing",i.length,"availability slots"),i.forEach((r,n)=>{if(!r.day||typeof r.start_time!="number"||typeof r.end_time!="number"){console.warn("Invalid slot data at index",n,":",r);return}const y=r.day.toLowerCase();if(!d[y]){console.warn("Invalid day key:",y);return}const t=Math.max(0,Math.min(23,r.start_time)),a=Math.max(t+1,Math.min(24,r.end_time));for(let s=t;s<a;s++)d[y].add(s)});const h=Object.values(d).reduce((r,n)=>r+n.size,0);console.log("Final loaded availability - total slots:",h),Object.entries(d).forEach(([r,n])=>{n.size>0&&console.log(`${r}: ${n.size} slots`,Array.from(n).sort())})}else console.log("No existing availability found or invalid data");M(d)}catch(g){console.error("Error loading availability:",g);const i={};U.forEach(m=>{i[m.toLowerCase()]=new Set}),M(i)}finally{A(!1)}},E=()=>x?.email==="ivanaguilarmari@gmail.com"?"Select all the time slots when you're available to go to the gym this week. Youssef will do the same, and I'll find the best matching times for your workouts.":"Select all the time slots when you're available to go to the gym this week. Ivan will do the same, and I'll find the best matching times for your workouts.",_=async g=>{if(console.log("handleSaveAvailability called with:",g),!c){console.error("No user found, cannot save availability"),k.error("You must be logged in to save availability");return}console.log("Saving availability for user:",c.id),A(!0);try{console.log("Deleting existing availability...");const{error:i,count:m}=await $.from("availability").delete({count:"exact"}).eq("user_id",c.id);i?console.error("Delete error:",i):console.log("Successfully deleted",m,"existing availability slots");const d=[];if(Object.entries(g).forEach(([h,r])=>{if(r.size===0)return;const n=Array.from(r).sort((a,s)=>a-s);let y=n[0],t=y+1;for(let a=1;a<n.length;a++)n[a]===t?t++:(d.push({user_id:c.id,day:h,start_time:y,end_time:t}),y=n[a],t=y+1);d.push({user_id:c.id,day:h,start_time:y,end_time:t})}),console.log("Slots to save:",d),d.length>0){const{data:h,error:r}=await $.from("availability").insert(d);if(console.log("Insert result:",{data:h,error:r}),r)throw console.error("Insert error:",r),r;console.log("Successfully inserted slots")}else console.log("No slots to save");k.success("Availability saved successfully!");try{console.log("Checking if both users have set availability..."),await V.sendAvailabilityNotification()&&k.success("ðŸ“± WhatsApp notifications sent to both users!")}catch(h){console.error("Failed to send WhatsApp notification:",h)}setTimeout(()=>{b("/dashboard")},1500)}catch(i){console.error("Error saving availability:",i),k.error(`Failed to save availability: ${i instanceof Error?i.message:"Unknown error"}`)}finally{A(!1)}};return p?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"mt-4 text-muted-foreground",children:"Loading availability..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs(C,{variant:"ghost",onClick:()=>b("/dashboard"),children:[e.jsx(B,{className:"mr-2 h-4 w-4"}),"Back to Dashboard"]}),e.jsxs(C,{variant:"outline",size:"sm",onClick:j,disabled:D||p,children:[e.jsx(P,{className:`mr-2 h-4 w-4 ${D?"animate-spin":""}`}),"Refresh"]})]}),e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold",children:"Set Your Availability"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:E()})]}),e.jsx(X,{onSave:_,initialAvailability:T})]})}const U=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];export{oe as Availability};
