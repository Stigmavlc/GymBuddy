import{j as e,e as U,g as Y,h as B,i as R}from"./ui-vendor-CRP0iqJy.js";import{r as x,d as q,u as P}from"./react-vendor-DWv6uwxK.js";import{C as M,a as z,b as G,B as k,e as I,c as H,u as J,s as W}from"./auth-BNfNio64.js";import{B as F}from"./badge-BuouczFH.js";import{a as _}from"./utils-vendor-BZaDkFqu.js";import{w as Q}from"./whatsappService-Vko0j1_p.js";import"./supabase-vendor-B9YYga7y.js";const N=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],O=Array.from({length:24},(d,p)=>p);function V({onSave:d,initialAvailability:p}){const[g,j]=x.useState(()=>{const t={};return N.forEach(a=>{t[a.toLowerCase()]=new Set}),t}),[A,D]=x.useState(!1),[E,L]=x.useState("add"),[$,S]=x.useState(!1),[s,n]=x.useState(0);x.useEffect(()=>{if(console.log("AvailabilityCalendar: Week offset changed to:",s),console.log("AvailabilityCalendar: Initial availability:",p),s===0&&p){const t={};N.forEach(a=>{const i=a.toLowerCase(),o=p[i];t[i]=o?new Set(o):new Set}),console.log("AvailabilityCalendar: Setting current week availability:",t),j(t),S(!1)}else{const t={};N.forEach(a=>{t[a.toLowerCase()]=new Set}),console.log("AvailabilityCalendar: Clearing availability for non-current week"),j(t),S(!1)}},[s,p]);const m=(t,a,i)=>{i&&"touches"in i&&i.preventDefault(),D(!0),S(!0);const o=t.toLowerCase(),u=g[o].has(a);L(u?"remove":"add"),j(c=>{const w={...c},C=new Set(w[o]);return u?C.delete(a):C.add(a),w[o]=C,w})},f=(t,a)=>{if(!A)return;const i=t.toLowerCase();j(o=>{const u={...o},c=new Set(u[i]);return E==="add"?c.add(a):c.delete(a),u[i]=c,u})},r=()=>{D(!1)},l=t=>{const a=t>=12?"PM":"AM";return`${t===0?12:t>12?t-12:t}${a}`},y=()=>{d(g),S(!1)},v=()=>{const t={};N.forEach(a=>{t[a.toLowerCase()]=new Set}),j(t),S(!0)},b=()=>{const t=Object.values(g).reduce((a,i)=>i instanceof Set?a+i.size:(console.warn("AvailabilityCalendar: Invalid daySlots detected:",i),a),0);return console.log("AvailabilityCalendar: Total slots calculated:",t),t},h=()=>{const t=new Date,a=new Date(t),i=t.getDay(),o=i===0?-6:1-i;return a.setDate(t.getDate()+o+s*7),N.map((u,c)=>{const w=new Date(a);return w.setDate(a.getDate()+c),w})},T=()=>{const t=h(),a=t[0],i=t[6],o=u=>u.toLocaleDateString("en-US",{month:"short",day:"numeric"});return a.getMonth()===i.getMonth()?`${o(a)} - ${o(i)}`:`${o(a)} - ${o(i)}`};return e.jsxs("div",{className:"w-full space-y-6",children:[e.jsx(M,{children:e.jsxs(z,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(U,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx(G,{className:"text-lg",children:"Set Your Availability"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Week of ",T()]})]})]}),e.jsxs(F,{variant:"secondary",children:[b()," slots selected"]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4",children:[e.jsxs(k,{variant:"outline",size:"sm",onClick:()=>n(s-1),disabled:s<=0,children:[e.jsx(Y,{className:"h-4 w-4 mr-1"}),"Previous Week"]}),e.jsx(k,{variant:"ghost",size:"sm",onClick:()=>n(0),disabled:s===0,children:"This Week"}),e.jsxs(k,{variant:"outline",size:"sm",onClick:()=>n(s+1),children:["Next Week",e.jsx(B,{className:"h-4 w-4 ml-1"})]})]})]})}),e.jsx("div",{className:"block lg:hidden space-y-4",children:N.map((t,a)=>{const o=h()[a],u=t.toLowerCase();return e.jsxs(M,{children:[e.jsx(z,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:t}),e.jsx("p",{className:"text-sm text-muted-foreground",children:o.toLocaleDateString("en-US",{month:"short",day:"numeric"})})]}),e.jsxs(F,{variant:"outline",children:[g[u].size," hours"]})]})}),e.jsx(I,{children:e.jsx("div",{className:"grid grid-cols-4 sm:grid-cols-6 gap-2",children:O.filter(c=>c>=6&&c<=23).map(c=>{const w=g[u].has(c);return e.jsx("button",{className:H("p-2 text-xs rounded border transition-all select-none",w?"bg-primary border-primary text-primary-foreground font-medium":"bg-background border-border hover:bg-muted active:bg-muted"),style:{touchAction:"manipulation",WebkitTapHighlightColor:"transparent"},onClick:C=>{C.preventDefault(),m(t,c,C)},children:l(c)},`${t}-${c}`)})})})]},t)})}),e.jsx(M,{className:"hidden lg:block",onMouseUp:r,onMouseLeave:r,children:e.jsx(I,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Click and drag to select your available time slots. Each slot represents 1 hour."}),e.jsx("div",{className:"overflow-x-auto",children:e.jsx("div",{className:"min-w-[800px]",children:e.jsxs("div",{className:"grid grid-cols-[80px_repeat(24,1fr)] gap-1",children:[e.jsx("div",{className:"h-8"}),O.map(t=>e.jsx("div",{className:"text-xs text-center text-muted-foreground",children:l(t)},t)),N.map(t=>e.jsxs(q.Fragment,{children:[e.jsx("div",{className:"font-medium text-sm py-2",children:e.jsx("div",{children:t})}),O.map(a=>{const i=t.toLowerCase(),o=g[i].has(a);return e.jsx("div",{className:H("h-10 border rounded cursor-pointer transition-all select-none",o?"bg-primary border-primary text-primary-foreground":"bg-background border-border hover:bg-muted"),style:{touchAction:"manipulation",WebkitTapHighlightColor:"transparent"},onMouseDown:u=>m(t,a,u),onMouseEnter:()=>f(t,a)},`${t}-${a}`)})]},t))]})})})]})})}),e.jsx(M,{children:e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 sm:justify-end",children:[e.jsx(k,{variant:"outline",onClick:v,className:"w-full sm:w-auto",children:"Clear All"}),e.jsx(k,{onClick:y,disabled:!$,className:"w-full sm:w-auto",children:"Save Availability"})]})})})]})}function re(){const{user:d,profile:p}=J(),g=P(),[j,A]=x.useState(!0),[D,E]=x.useState();x.useEffect(()=>{if(d){L();const s=W.channel("availability-changes").on("postgres_changes",{event:"*",schema:"public",table:"availability",filter:`user_id=eq.${d.id}`},()=>{L()}).subscribe();return()=>{s.unsubscribe()}}},[d]);const L=async()=>{if(d)try{console.log("Loading availability for user:",d.id);const{data:s,error:n}=await W.from("availability").select("*").eq("user_id",d.id).order("created_at",{ascending:!1});console.log("Load availability result:",{data:s,error:n,count:s?.length||0}),n&&console.error("Error loading availability:",n);const m={};if(K.forEach(f=>{m[f.toLowerCase()]=new Set}),s&&Array.isArray(s)&&s.length>0){console.log("Processing",s.length,"availability slots"),s.forEach((r,l)=>{if(!r.day||typeof r.start_time!="number"||typeof r.end_time!="number"){console.warn("Invalid slot data at index",l,":",r);return}const y=r.day.toLowerCase();if(!m[y]){console.warn("Invalid day key:",y);return}const v=Math.max(0,Math.min(23,r.start_time)),b=Math.max(v+1,Math.min(24,r.end_time));for(let h=v;h<b;h++)m[y].add(h)});const f=Object.values(m).reduce((r,l)=>r+l.size,0);console.log("Final loaded availability - total slots:",f),Object.entries(m).forEach(([r,l])=>{l.size>0&&console.log(`${r}: ${l.size} slots`,Array.from(l).sort())})}else console.log("No existing availability found or invalid data");E(m)}catch(s){console.error("Error loading availability:",s);const n={};K.forEach(m=>{n[m.toLowerCase()]=new Set}),E(n)}finally{A(!1)}},$=()=>p?.email==="ivanaguilarmari@gmail.com"?"Select all the time slots when you're available to go to the gym this week. Youssef will do the same, and I'll find the best matching times for your workouts.":"Select all the time slots when you're available to go to the gym this week. Ivan will do the same, and I'll find the best matching times for your workouts.",S=async s=>{if(console.log("handleSaveAvailability called with:",s),!d){console.error("No user found, cannot save availability"),_.error("You must be logged in to save availability");return}console.log("Saving availability for user:",d.id),A(!0);try{console.log("Deleting existing availability...");const{error:n,count:m}=await W.from("availability").delete({count:"exact"}).eq("user_id",d.id);n?console.error("Delete error:",n):console.log("Successfully deleted",m,"existing availability slots");const f=[];if(Object.entries(s).forEach(([r,l])=>{if(l.size===0)return;const y=Array.from(l).sort((h,T)=>h-T);let v=y[0],b=v+1;for(let h=1;h<y.length;h++)y[h]===b?b++:(f.push({user_id:d.id,day:r,start_time:v,end_time:b}),v=y[h],b=v+1);f.push({user_id:d.id,day:r,start_time:v,end_time:b})}),console.log("Slots to save:",f),f.length>0){const{data:r,error:l}=await W.from("availability").insert(f);if(console.log("Insert result:",{data:r,error:l}),l)throw console.error("Insert error:",l),l;console.log("Successfully inserted slots")}else console.log("No slots to save");_.success("Availability saved successfully!");try{console.log("Checking if both users have set availability..."),await Q.sendAvailabilityNotification()&&_.success("ðŸ“± WhatsApp notifications sent to both users!")}catch(r){console.error("Failed to send WhatsApp notification:",r)}setTimeout(()=>{g("/dashboard")},1500)}catch(n){console.error("Error saving availability:",n),_.error(`Failed to save availability: ${n instanceof Error?n.message:"Unknown error"}`)}finally{A(!1)}};return j?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"mt-4 text-muted-foreground",children:"Loading availability..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(k,{variant:"ghost",onClick:()=>g("/dashboard"),className:"mb-4",children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"Back to Dashboard"]}),e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold",children:"Set Your Availability"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:$()})]}),e.jsx(V,{onSave:S,initialAvailability:D})]})}const K=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];export{re as Availability};
