import{j as e,e as F,g as K,h as U,i as B,k as q}from"./ui-vendor-Dh6LInB3.js";import{r as g,d as P,u as G}from"./react-vendor-DWv6uwxK.js";import{C as _,a as O,b as J,B as N,e as I,c as H,u as Q,s as $}from"./auth-C16P3Hdi.js";import{B as R}from"./badge-CMmAzan2.js";import{a as k}from"./utils-vendor-BZaDkFqu.js";import{w as V}from"./whatsappService-D9rksAF1.js";import"./supabase-vendor-B9YYga7y.js";const S=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],z=Array.from({length:24},(d,x)=>x);function X({onSave:d,initialAvailability:x}){const[b,p]=g.useState(()=>{const t={};return S.forEach(a=>{t[a.toLowerCase()]=new Set}),t}),[A,D]=g.useState(!1),[L,T]=g.useState("add"),[M,j]=g.useState(!1),[h,E]=g.useState(0);g.useEffect(()=>{if(console.log("AvailabilityCalendar: Week offset changed to:",h),console.log("AvailabilityCalendar: Initial availability:",x),h===0&&x){const t={};S.forEach(a=>{const s=a.toLowerCase(),r=x[s];t[s]=r?new Set(r):new Set}),console.log("AvailabilityCalendar: Setting current week availability:",t),p(t),j(!1)}else{const t={};S.forEach(a=>{t[a.toLowerCase()]=new Set}),console.log("AvailabilityCalendar: Clearing availability for non-current week"),p(t),j(!1)}},[h,x]);const W=(t,a,s)=>{s&&"touches"in s&&s.preventDefault(),D(!0),j(!0);const r=t.toLowerCase(),u=b[r].has(a);T(u?"remove":"add"),p(c=>{const w={...c},C=new Set(w[r]);return u?C.delete(a):C.add(a),w[r]=C,w})},n=(t,a)=>{if(!A)return;const s=t.toLowerCase();p(r=>{const u={...r},c=new Set(u[s]);return L==="add"?c.add(a):c.delete(a),u[s]=c,u})},o=()=>{D(!1)},m=t=>{const a=t>=12?"PM":"AM";return`${t===0?12:t>12?t-12:t}${a}`},f=()=>{d(b),j(!1)},i=()=>{const t={};S.forEach(a=>{t[a.toLowerCase()]=new Set}),p(t),j(!0)},l=()=>{const t=Object.values(b).reduce((a,s)=>s instanceof Set?a+s.size:(console.warn("AvailabilityCalendar: Invalid daySlots detected:",s),a),0);return console.log("AvailabilityCalendar: Total slots calculated:",t),t},y=()=>{const t=new Date,a=new Date(t),s=t.getDay(),r=s===0?-6:1-s;return a.setDate(t.getDate()+r+h*7),S.map((u,c)=>{const w=new Date(a);return w.setDate(a.getDate()+c),w})},v=()=>{const t=y(),a=t[0],s=t[6],r=u=>u.toLocaleDateString("en-US",{month:"short",day:"numeric"});return a.getMonth()===s.getMonth()?`${r(a)} - ${r(s)}`:`${r(a)} - ${r(s)}`};return e.jsxs("div",{className:"w-full space-y-6",children:[e.jsx(_,{children:e.jsxs(O,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(F,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx(J,{className:"text-lg",children:"Set Your Availability"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Week of ",v()]})]})]}),e.jsxs(R,{variant:"secondary",children:[l()," slots selected"]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4",children:[e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>E(h-1),disabled:h<=0,children:[e.jsx(K,{className:"h-4 w-4 mr-1"}),"Previous Week"]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>E(0),disabled:h===0,children:"This Week"}),e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>E(h+1),children:["Next Week",e.jsx(U,{className:"h-4 w-4 ml-1"})]})]})]})}),e.jsx("div",{className:"block lg:hidden space-y-4",children:S.map((t,a)=>{const r=y()[a],u=t.toLowerCase();return e.jsxs(_,{children:[e.jsx(O,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:t}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r.toLocaleDateString("en-US",{month:"short",day:"numeric"})})]}),e.jsxs(R,{variant:"outline",children:[b[u].size," hours"]})]})}),e.jsx(I,{children:e.jsx("div",{className:"grid grid-cols-4 sm:grid-cols-6 gap-2",children:z.filter(c=>c>=6&&c<=23).map(c=>{const w=b[u].has(c);return e.jsx("button",{className:H("p-2 text-xs rounded border transition-all select-none",w?"bg-primary border-primary text-primary-foreground font-medium":"bg-background border-border hover:bg-muted active:bg-muted"),style:{touchAction:"manipulation",WebkitTapHighlightColor:"transparent"},onClick:C=>{C.preventDefault(),W(t,c,C)},children:m(c)},`${t}-${c}`)})})})]},t)})}),e.jsx(_,{className:"hidden lg:block",onMouseUp:o,onMouseLeave:o,children:e.jsx(I,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Click and drag to select your available time slots. Each slot represents 1 hour."}),e.jsx("div",{className:"overflow-x-auto",children:e.jsx("div",{className:"min-w-[800px]",children:e.jsxs("div",{className:"grid grid-cols-[80px_repeat(24,1fr)] gap-1",children:[e.jsx("div",{className:"h-8"}),z.map(t=>e.jsx("div",{className:"text-xs text-center text-muted-foreground",children:m(t)},t)),S.map(t=>e.jsxs(P.Fragment,{children:[e.jsx("div",{className:"font-medium text-sm py-2",children:e.jsx("div",{children:t})}),z.map(a=>{const s=t.toLowerCase(),r=b[s].has(a);return e.jsx("div",{className:H("h-10 border rounded cursor-pointer transition-all select-none",r?"bg-primary border-primary text-primary-foreground":"bg-background border-border hover:bg-muted"),style:{touchAction:"manipulation",WebkitTapHighlightColor:"transparent"},onMouseDown:u=>W(t,a,u),onMouseEnter:()=>n(t,a)},`${t}-${a}`)})]},t))]})})})]})})}),e.jsx(_,{children:e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 sm:justify-end",children:[e.jsx(N,{variant:"outline",onClick:i,className:"w-full sm:w-auto",children:"Clear All"}),e.jsx(N,{onClick:f,disabled:!M,className:"w-full sm:w-auto",children:"Save Availability"})]})})})]})}function oe(){const{user:d,profile:x}=Q(),b=G(),[p,A]=g.useState(!0),[D,L]=g.useState(!1),[T,M]=g.useState();g.useEffect(()=>{if(d){h();const n=$.channel("availability-changes").on("postgres_changes",{event:"*",schema:"public",table:"availability",filter:`user_id=eq.${d.id}`},o=>{console.log("Availability page: Change detected:",o),h(),k.info("Your availability has been updated",{description:"The changes are now reflected on the calendar"})}).subscribe();return()=>{n.unsubscribe()}}},[d]);const j=async()=>{L(!0),await h(),k.success("Availability refreshed"),L(!1)},h=async()=>{if(d)try{console.log("Loading availability for user:",d.id);const{data:n,error:o}=await $.from("availability").select("*").eq("user_id",d.id).order("created_at",{ascending:!1});console.log("Load availability result:",{data:n,error:o,count:n?.length||0}),o&&console.error("Error loading availability:",o);const m={};if(Y.forEach(f=>{m[f.toLowerCase()]=new Set}),n&&Array.isArray(n)&&n.length>0){console.log("Processing",n.length,"availability slots"),n.forEach((i,l)=>{if(!i.day||typeof i.start_time!="number"||typeof i.end_time!="number"){console.warn("Invalid slot data at index",l,":",i);return}const y=i.day.toLowerCase();if(!m[y]){console.warn("Invalid day key:",y);return}const v=Math.max(0,Math.min(23,i.start_time)),t=Math.max(v+1,Math.min(24,i.end_time));for(let a=v;a<t;a++)m[y].add(a)});const f=Object.values(m).reduce((i,l)=>i+l.size,0);console.log("Final loaded availability - total slots:",f),Object.entries(m).forEach(([i,l])=>{l.size>0&&console.log(`${i}: ${l.size} slots`,Array.from(l).sort())})}else console.log("No existing availability found or invalid data");M(m)}catch(n){console.error("Error loading availability:",n);const o={};Y.forEach(m=>{o[m.toLowerCase()]=new Set}),M(o)}finally{A(!1)}},E=()=>x?.email==="ivanaguilarmari@gmail.com"?"Select all the time slots when you're available to go to the gym this week. Youssef will do the same, and I'll find the best matching times for your workouts.":"Select all the time slots when you're available to go to the gym this week. Ivan will do the same, and I'll find the best matching times for your workouts.",W=async n=>{if(console.log("handleSaveAvailability called with:",n),!d){console.error("No user found, cannot save availability"),k.error("You must be logged in to save availability");return}console.log("Saving availability for user:",d.id),A(!0);try{console.log("Deleting existing availability...");const{error:o,count:m}=await $.from("availability").delete({count:"exact"}).eq("user_id",d.id);o?console.error("Delete error:",o):console.log("Successfully deleted",m,"existing availability slots");const f=[];if(Object.entries(n).forEach(([i,l])=>{if(l.size===0)return;const y=Array.from(l).sort((a,s)=>a-s);let v=y[0],t=v+1;for(let a=1;a<y.length;a++)y[a]===t?t++:(f.push({user_id:d.id,day:i,start_time:v,end_time:t}),v=y[a],t=v+1);f.push({user_id:d.id,day:i,start_time:v,end_time:t})}),console.log("Slots to save:",f),f.length>0){const{data:i,error:l}=await $.from("availability").insert(f);if(console.log("Insert result:",{data:i,error:l}),l)throw console.error("Insert error:",l),l;console.log("Successfully inserted slots")}else console.log("No slots to save");k.success("Availability saved successfully!");try{console.log("Checking if both users have set availability..."),await V.sendAvailabilityNotification()&&k.success("ðŸ“± WhatsApp notifications sent to both users!")}catch(i){console.error("Failed to send WhatsApp notification:",i)}setTimeout(()=>{b("/dashboard")},1500)}catch(o){console.error("Error saving availability:",o),k.error(`Failed to save availability: ${o instanceof Error?o.message:"Unknown error"}`)}finally{A(!1)}};return p?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"mt-4 text-muted-foreground",children:"Loading availability..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs(N,{variant:"ghost",onClick:()=>b("/dashboard"),children:[e.jsx(B,{className:"mr-2 h-4 w-4"}),"Back to Dashboard"]}),e.jsxs(N,{variant:"outline",size:"sm",onClick:j,disabled:D||p,children:[e.jsx(q,{className:`mr-2 h-4 w-4 ${D?"animate-spin":""}`}),"Refresh"]})]}),e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold",children:"Set Your Availability"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:E()})]}),e.jsx(X,{onSave:W,initialAvailability:T})]})}const Y=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];export{oe as Availability};
